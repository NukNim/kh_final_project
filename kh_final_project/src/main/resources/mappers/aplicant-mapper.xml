<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="applicant">
	
	<select id="recruitTitle" resultType="kh.com.job.business.model.dto.BsRecruitDto">
		SELECT RA_NUM, RA_TITLE FROM RECRUIT_REGIST
		WHERE USER_ID = #{userId}
	</select>

	
	<select id="aplicantAll" resultType="_int">
		select count(*) 
		from BUSINESS_APPLICANT ba 
		join RECRUIT_REGIST rr on ba.ra_num = rr.ra_num
		where rr.user_id = #{userId}
	</select>
	
<!-- 	<select id="aplicantList" resultType="kh.com.job.business.model.dto.BsAplicantDto">
	select  ba.ba_num, ba.user_id, ba.resume_no
        , ur.resume_title, ur.resume_act,  ua.apply_date
        , ba.result_type
	from BUSINESS_APPLICANT ba 
	join user_resume ur ON ba.RESUME_NO = ur.RESUME_NO
	join user_apply ua ON ba.ba_num = ua.ba_num
	where ba.ra_num = #{raNum}
	</select> -->
	
	<select id="recruitList" resultType="kh.com.job.business.model.dto.BsAplicantRecruitDto">
	select rr.ra_num
		, rr.ra_title
		, (select count(*) from BUSINESS_APPLICANT ba where ba.ra_num = rr.ra_num and result_type = 'N') as failconut
		, (select count(*) from BUSINESS_APPLICANT ba where ba.ra_num = rr.ra_num and result_type = 'Y') as passconut
		, (select count(*) from BUSINESS_APPLICANT ba where ba.ra_num = rr.ra_num ) as aplicount
	from recruit_regist rr
	where rr.user_id = #{userId}
	</select>
	
	<!-- 캘린더 -->	
	<select id="viewInterview" resultType="indto">
		SELECT CA_NUM,CA_TITLE,DATE_START,DATE_END,LOCATION,INTERVIEWER,MEMO,USER_ID
		FROM INTERVIEW
		WHERE USER_ID = #{userId}
	</select>

	<insert id="insertInterview" parameterType="indto">
	INSERT INTO
	INTERVIEW (CA_NUM,CA_TITLE,DATE_START,DATE_END,LOCATION,INTERVIEWER,MEMO,USER_ID)
	VALUES (#{caNum},#{caTitle},#{dateStart},#{dateEnd},#{location},#{interviewer},#{memo},#{userId})
		<selectKey keyProperty="caNum" resultType="_int"
			order="BEFORE">
			SELECT MAX(CA_NUM) +1 FROM INTERVIEW
		</selectKey>
	</insert>

	<!-- 페이지 리스트 카운트 -->
	<select id="pageListCount" resultType="_int">
		select count(*) from business_applicant ba
		join recruit_regist rr on ba.ra_num = rr.ra_num
		join user_apply ua ON ba.ba_num = ua.ba_num
		<trim prefix="where" prefixOverrides="AND|OR">
			<if test="searchNum != null and searchNum neq ''">
				ba.RA_NUM like '%'||#{searchNum}||'%'
			</if>
			<if test="searchResult != null and searchResult neq ''">
				AND ba.result_type like '%'||#{searchResult}||'%'
			</if>
		</trim>
	</select>
	
	<select id="pageList" resultType="kh.com.job.business.model.dto.BsAplicantListDto">
		select user_id, resume_no, RESULT_TYPE
			    , ra_num, ra_title, apply_date
		FROM(
			SELECT ROWNUM AS NUM , A.*
			FROM (
					select ba.user_id, ba.resume_no, ba.RESULT_TYPE
					    , rr.ra_num, rr.ra_title, ua.apply_date
					from business_applicant ba
					join recruit_regist rr on ba.ra_num = rr.ra_num
					join user_apply ua ON ba.ba_num = ua.ba_num
			<trim prefix="where" prefixOverrides="AND|OR">
				<if test="searchNum != null and searchNum neq ''">
					ba.RA_NUM like '%'||#{searchNum}||'%'
				</if>
				<if test="searchResult != null and searchResult neq ''">
					AND ba.result_type like '%'||#{searchResult}||'%'
				</if>
			</trim>
				ORDER BY ua.apply_date DESC
			) A
			)
		WHERE NUM BETWEEN #{startNum} AND #{endNum}
	</select>

	
</mapper>